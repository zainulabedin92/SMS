!function(t){function e(e,i){t(window).trigger(e,i)}var i=Backbone.Model.extend({initialize:function(){},defaults:{plugins_required:[],demo:null,packages:[]}}),s=Backbone.Model.extend({initialize:function(){},defaults:{demos:[]}}),a=Backbone.View.extend({el:".tc-modal-importer",doing_import:!1,current_request:null,model:{},events:{"click .close":"close","click #start-import":"import","click #retry-import":"retry_import","click .package:not(.disabled, .obligatory)":"onChangePackage"},try_again_step:0,try_again_step_max:50,retry:0,retry_max:5,failed:!1,message_error:!1,template:function(t){var e=this.$el.attr("data-template");return wp.template(e)(t)},initialize:function(){this.model=new i(thim_importer_data),this.render();var e=this;t(document).on("click",".tc-modal-importer .tc-open-modal",(function(t){e.close()}))},onChangePackage:function(t){if(!this.doing_import){var e=this.$(t.currentTarget),i=e.find("input");i.prop("checked",!i.prop("checked"));var s=e.data("package");this._checkRequired(s)}},_checkRequired:function(t){var e=this.$('.package[data-required="'+t+'"]');if(0!==e.length){var i=e.data("package"),s=this.$("#importer-"+i),a=this.$("#importer-"+t).prop("checked");s.attr("disabled",!a),e.toggleClass("disabled")}},open:function(e){this.$el.addClass("md-show"),this.$(".main").scrollTop(0),t(".thim-dashboard").addClass("thim-modal-open"),this.model.set("demo",e),this.update()},close:function(){if(this.doing_import&&!window.confirm(thim_importer_data.confirm_close))return;this._finish(),this.$el.removeClass("md-show"),t(".thim-dashboard").removeClass("thim-modal-open"),this.reset()},reset:function(){this.doing_import=!1,this.$("input").attr("disabled",!1),this.$("#start-import").attr("disabled",!1),this.$("input").prop("checked",!0),this.$(".package").removeClass("disabled").removeAttr("data-status").removeAttr("data-percentage"),this.$el.removeClass("importing completed"),this.$(".package-progress-bar").css("width",0)},update:function(){var t=this.model.get("demo");this.$(".demo-name").text(t.title);var e=t.revsliders||[];this.$(".package.revslider").removeClass("disabled"),e.length||this.$(".package.revslider").addClass("disabled"),this.updatePluginsRequired(t)},import:function(){this._updatePackages(),this.$("#start-import").attr("disabled",!0),this.$el.addClass("importing"),this.$("input").attr("disabled",!0),this._startImport()},retry_import:function(){this.reset(),this.retry++,this.import()},_updatePackages:function(){var e=[];this.$(".package:not(.disabled) input:checked").each((function(){var i=t(this).parents(".package").data("package");e.push(i)})),this.model.set("packages",e),0===e.length?this.$("#start-import").attr("disabled",!0):this.$("#start-import").attr("disabled",!1)},_startImport:function(){this.doing_import=!0,this._initImport()},_initImport:function(){this._lockWindow();var t=this.model.get("demo"),e=this.model.get("packages"),i=this.failed;let s={action:"thim_importer",demo:t.key,packages:e,retry:i,step:"start"};this._handleStep(s)},_handleStep:function(e){const i=this,s=this.model.get("url_ajax"),a=t("li[data-package="+e.step+"]");a.attr("data-status","running"),this._scrollTo(e.step),this.current_request=t.ajax({url:s,method:"POST",data:e,dataType:"json"}).success((function(t){if("success"===t.status){const s=a.find(".package-progress-bar");s&&s.css("width",t.percentage+"%"),""!==t.step?(t.step!==e.step&&a.attr("data-status","completed"),e.step=t.step,e.extra=t.extra,setTimeout((function(){i._handleStep(e)}),500)):i._notifySuccess()}else a.removeAttr("data-status"),i._notifyError(t.message)})).error((function(t){return i.retry<i.retry_max?i._handleStep(e):i._notifyErrorAjax(t)}))},_stepByStep:function(e){this.$(".package."+e).attr("data-status","running"),this._scrollTo(e);var i=this;this.current_request=t.ajax({url:this.model.get("url_ajax"),method:"POST",dataType:"text",data:{action:"thim_importer",time:(new Date).getTime()}}).success((function(t){if(!(t=i._parseJSON(t)))return i.try_again_step+=1,i.try_again_step>i.try_again_step_max?i._notifyError({code:"#002",title:"Something went wrong!"}):i._stepByStep(e);var s=t.success||!1,a=t.data;if(!s){i.try_again_step+=1;var r=a.code||"";return i.try_again_step>i.try_again_step_max||r.includes("008_DOWNLOAD_FAILED")?i._notifyError(a):i._stepByStep(e)}var n=a.done||!1;if(n)i.$(".package."+n).attr("data-status","completed").attr({"data-percentage":"100%"}).find(".package-progress-bar").css("width","100%");else if(a.ext&&-1!==["media","main_content","plugins"].indexOf(a.next)){var o=a.ext.percentage||2;i.$(".package."+a.next).attr({"data-percentage":o+"%"}).find(".package-progress-bar").css("width",o+"%")}var l=a.next;if(!l)return i._notifySuccess();i._stepByStep(l)})).error((function(t){return i.try_again_step+=1,i.try_again_step>i.try_again_step_max?i._notifyErrorAjax(t):i._stepByStep(e)}))},_scrollTo:function(e){var i=this.$(".main"),s=t(".package."+e);s.length&&i.stop().animate({scrollTop:s.offset().top-i.offset().top+i.scrollTop()},500)},_parseJSON:function(t){var e=t.match(/<!-- THIM_IMPORT_START -->(.*)<!-- THIM_IMPORT_END -->/);try{t=e?JSON.parse(e[1]):JSON.parse(t)}catch(e){t=!1}return t},_notifyErrorAjax:function(t){var e=thim_importer_data.details_error,i={title:e.title};return 200===t.status?(i.code=e.code.request,this._notifyError(i)):!(t.status>200)||(this.failed=!0,i.code=e.code.server,this.retry<this.retry_max?this._notify_retry(e.try_again):this._notifyError(i))},_notify_retry:function(t){return this.$(".wrapper-finish .details-error").find(".how-to").html(t).show(),this.$(".wrapper-finish").removeClass("success").addClass("failed retry"),this._finish(),!0},_notifyError:function(t){this._emitEvent("thim_importer_failed");return this.$(".wrapper-finish .details-error").find("h3").html(t),this.$(".wrapper-finish").removeClass("success retry").addClass("failed"),this._finish(),this.message_error="[Import Demo Content] "+t,!0},_notifySuccess:function(){return this.failed=!1,this._emitEvent("thim_importer_complete",this.model.get("demo")),this.$(".wrapper-finish").removeClass("failed").addClass("success"),this._finish(),!0},_finish:function(){return this._forceStop(),!0},_forceStop:function(){this.$el.removeClass("importing").addClass("completed"),this.doing_import=!1,this._unlockWindow(),this.current_request&&this.current_request.abort()},_lockWindow:function(){window.onbeforeunload=function(){return"The import process will cause errors if you leave this page!"}},_unlockWindow:function(){window.onbeforeunload=null},_emitEvent:function(e,i){t(window).trigger(e,i)},updatePluginsRequired:function(){},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),r=Backbone.View.extend({el:".tc-modal-importer-uninstall",model:{},current_request:!1,doing_uninstall:!1,events:{"click .close":"close","click .tc-start":"startUninstall"},template:function(t){var e=this.$el.attr("data-template");return wp.template(e)(t)},initialize:function(){this.model=new i(thim_importer_data),this.render()},open:function(){this.$el.addClass("md-show"),this.$(".main").scrollTop(0),this.$(".tc-start").removeClass("updating-message").attr("disabled",!1),t(".thim-dashboard").addClass("thim-modal-open")},close:function(){if(this.doing_uninstall&&!window.confirm(thim_importer_data.confirm_close))return;this.$el.removeClass("md-show"),t(".thim-dashboard").removeClass("thim-modal-open"),this.reset()},startUninstall:function(){this.$(".tc-start").addClass("updating-message").attr("disabled",!0);var i=this;i.$el.addClass("running"),this.current_request=t.ajax({url:this.model.get("url_ajax"),method:"POST",dataType:"text",data:{action:"thim_importer_uninstall"}}).success((function(t){(t=function(t){var e=t.match(/<!-- THIM_IMPORT_START -->(.*)<!-- THIM_IMPORT_END -->/);try{t=e?JSON.parse(e[1]):JSON.parse(t)}catch(e){t=!1}return t}(t)).success?(i.notify("success",thim_importer_data.uninstall_successful),e("thim_uninstall_demo_successful")):(i.notify("error",thim_importer_data.uninstall_failed),e("thim_uninstall_demo_failed"))})).error((function(t){"abort"!==t.statusText&&(i.$(".tc-start").attr("disabled",!1),i.notify("error",thim_importer_data.something_went_wrong),e("thim_uninstall_demo_failed"))})).complete((function(){i.$(".tc-start").removeClass("updating-message"),i.$el.removeClass("running"),e("thim_uninstall_demo_complete")}))},notify:function(t,e){if("error"===t)this.$(".tc-success").hide(),this.$(".tc-error").show().find(".content").text(e);else this.$(".tc-error").hide(),this.$(".tc-success").show().find(".content").text(e)},reset:function(){this.$(".tc-start").attr("disabled",!1),this.$(".notifications > *").hide()},render:function(){this.$el.html(this.template({}))}}),n=Backbone.View.extend({el:".tc-importer-wrapper",form_install:null,form_uninstall:null,model:null,audio_complete:null,events:{"click .action-import":"openInstall","click .thim-screenshot":"openInstall","click .btn-uninstall":"openUninstall"},initialize:function(){this.audio_complete=new Audio("https://thimpresswp.github.io/thim-core/static/complete.mp3"),t(window).on("thim_importer_complete",this.onImportSuccess.bind(this)),t(window).on("thim_uninstall_demo_successful",this.onUninstallSuccess.bind(this)),this.model.on("change:installed",this.updateDemoInstalled.bind(this)),this.render(),this.form_install=new a,this.form_uninstall=new r},template:function(t){var e=this.$el.attr("data-template");return wp.template(e)(t)},render:function(){this.$el.html(this.template(this.model.toJSON()))},onImportSuccess:function(t,e){this.audio_complete.play(),this.model.set("installed",e.key)},onUninstallSuccess:function(t){this.model.set("installed",!1),this.render()},updateDemoInstalled:function(){this.model.get("installed");this.$(".thim-demo").removeClass("installed active"),this.render()},openUninstall:function(t){this.form_uninstall.open()},openInstall:function(e){if(e.preventDefault(),Thim_Core.check_active()){var i=e.target,s=t(i).closest(".thim-demo").data("thim-demo"),a=this.model.get("demos");this.form_install.open(a[s])}}});t(document).ready((function(){new n({model:new s(thim_importer)})}))}(jQuery);
